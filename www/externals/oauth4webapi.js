/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/oauth4webapi@3.5.0/build/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
let e;if("undefined"==typeof navigator||!navigator.userAgent?.startsWith?.("Mozilla/5.0 ")){e=`${"oauth4webapi"}/${"v3.5.0"}`}function t(e,t){if(null==e)return!1;try{return e instanceof t||Object.getPrototypeOf(e)[Symbol.toStringTag]===t.prototype[Symbol.toStringTag]}catch{return!1}}const n="ERR_INVALID_ARG_VALUE",a="ERR_INVALID_ARG_TYPE";function s(e,t,n){const a=new TypeError(e,{cause:n});return Object.assign(a,{code:t}),a}const r=Symbol(),i=Symbol(),o=Symbol(),c=Symbol(),u=Symbol(),d=Symbol(),p=Symbol(),h=new TextEncoder,l=new TextDecoder;function f(e){return"string"==typeof e?h.encode(e):l.decode(e)}function m(e){return"string"==typeof e?function(e){try{const t=atob(e.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}catch(e){throw s("The input to be decoded is not correctly encoded.",n,e)}}(e):function(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));const t=[];for(let n=0;n<e.byteLength;n+=32768)t.push(String.fromCharCode.apply(null,e.subarray(n,n+32768)));return btoa(t.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}(e)}class y extends Error{code;constructor(e,t){super(e,t),this.name=this.constructor.name,this.code=at,Error.captureStackTrace?.(this,this.constructor)}}class w extends Error{code;constructor(e,t){super(e,t),this.name=this.constructor.name,t?.code&&(this.code=t?.code),Error.captureStackTrace?.(this,this.constructor)}}function _(e,t,n){return new w(e,{code:t,cause:n})}function b(e,t){if(!(e instanceof CryptoKey))throw s(`${t} must be a CryptoKey`,a)}function g(e,t){if(b(e,t),"private"!==e.type)throw s(`${t} must be a private CryptoKey`,n)}function S(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function v(a){t(a,Headers)&&(a=Object.fromEntries(a.entries()));const r=new Headers(a);if(e&&!r.has("user-agent")&&r.set("user-agent",e),r.has("authorization"))throw s('"options.headers" must not include the "authorization" header name',n);return r}function k(e){if("function"==typeof e&&(e=e()),!(e instanceof AbortSignal))throw s('"options.signal" must return or be an instance of AbortSignal',a);return e}function P(e){return e.includes("//")?e.replace("//","/"):e}function R(e,t){return"/"===e.pathname?e.pathname=t:e.pathname=P(`${t}/${e.pathname}`),e}async function x(e,t,n,i){if(!(e instanceof URL))throw s(`"${t}" must be an instance of URL`,a);se(e,!0!==i?.[r]);const o=n(new URL(e.href)),u=v(i?.headers);return u.set("accept","application/json"),(i?.[c]||fetch)(o.href,{body:void 0,headers:Object.fromEntries(u.entries()),method:"GET",redirect:"manual",signal:i?.signal?k(i.signal):void 0})}async function A(e,t){return x(e,"issuerIdentifier",(e=>{switch(t?.algorithm){case void 0:case"oidc":!function(e,t){e.pathname=P(`${e.pathname}/${t}`)}(e,".well-known/openid-configuration");break;case"oauth2":R(e,".well-known/oauth-authorization-server");break;default:throw s('"options.algorithm" must be "oidc" (default), or "oauth2"',n)}return e}),t)}function T(e,t,r,i,o){try{if("number"!=typeof e||!Number.isFinite(e))throw s(`${r} must be a number`,a,o);if(e>0)return;if(t){if(0!==e)throw s(`${r} must be a non-negative number`,n,o);return}throw s(`${r} must be a positive number`,n,o)}catch(e){if(i)throw _(e.message,i,o);throw e}}function E(e,t,r,i){try{if("string"!=typeof e)throw s(`${t} must be a string`,a,i);if(0===e.length)throw s(`${t} must not be empty`,n,i)}catch(e){if(r)throw _(e.message,r,i);throw e}}async function j(e,n){const r=e;if(!(r instanceof URL)&&r!==fn)throw s('"expectedIssuerIdentifier" must be an instance of URL',a);if(!t(n,Response))throw s('"response" must be an instance of Response',a);if(200!==n.status)throw _('"response" is not a conform Authorization Server Metadata response (unexpected HTTP status code)',dt,n);xt(n);const i=await hn(n);if(E(i.issuer,'"response" body "issuer" property',ot,{body:i}),r!==fn&&new URL(i.issuer).href!==r.href)throw _('"response" body "issuer" property does not match the expected value',mt,{expected:r.href,body:i,attribute:"issuer"});return i}function O(e){!function(e,t){if(Ue(e)!==t)throw U(e,t)}(e,"application/json")}function U(e,...t){let n='"response" content-type must be ';if(t.length>2){const e=t.pop();n+=`${t.join(", ")}, or ${e}`}else 2===t.length?n+=`${t[0]} or ${t[1]}`:n+=t[0];return _(n,ut,e)}function D(){return m(crypto.getRandomValues(new Uint8Array(32)))}function L(){return D()}function H(){return D()}function J(){return D()}async function W(e){return E(e,"codeVerifier"),m(await crypto.subtle.digest("SHA-256",f(e)))}function N(e){return e instanceof CryptoKey?{key:e}:e?.key instanceof CryptoKey?(void 0!==e.kid&&E(e.kid,'"kid"'),{key:e.key,kid:e.kid}):{}}function I(e){switch(e.algorithm.name){case"RSA-PSS":return function(e){switch(e.algorithm.hash.name){case"SHA-256":return"PS256";case"SHA-384":return"PS384";case"SHA-512":return"PS512";default:throw new y("unsupported RsaHashedKeyAlgorithm hash name",{cause:e})}}(e);case"RSASSA-PKCS1-v1_5":return function(e){switch(e.algorithm.hash.name){case"SHA-256":return"RS256";case"SHA-384":return"RS384";case"SHA-512":return"RS512";default:throw new y("unsupported RsaHashedKeyAlgorithm hash name",{cause:e})}}(e);case"ECDSA":return function(e){switch(e.algorithm.namedCurve){case"P-256":return"ES256";case"P-384":return"ES384";case"P-521":return"ES512";default:throw new y("unsupported EcKeyAlgorithm namedCurve",{cause:e})}}(e);case"Ed25519":case"EdDSA":return"Ed25519";default:throw new y("unsupported CryptoKey algorithm name",{cause:e})}}function C(e){const t=e?.[i];return"number"==typeof t&&Number.isFinite(t)?t:0}function $(e){const t=e?.[o];return"number"==typeof t&&Number.isFinite(t)&&-1!==Math.sign(t)?t:30}function z(){return Math.floor(Date.now()/1e3)}function K(e){if("object"!=typeof e||null===e)throw s('"as" must be an object',a);E(e.issuer,'"as.issuer"')}function q(e){if("object"!=typeof e||null===e)throw s('"client" must be an object',a);E(e.client_id,'"client.client_id"')}function M(e){return encodeURIComponent(e).replace(/(?:[-_.!~*'()]|%20)/g,(e=>{switch(e){case"-":case"_":case".":case"!":case"~":case"*":case"'":case"(":case")":return`%${e.charCodeAt(0).toString(16).toUpperCase()}`;case"%20":return"+";default:throw new Error}}))}function F(e){return E(e,'"clientSecret"'),(t,n,a,s)=>{a.set("client_id",n.client_id),a.set("client_secret",e)}}function V(e){return E(e,'"clientSecret"'),(t,n,a,s)=>{const r=M(n.client_id),i=M(e),o=btoa(`${r}:${i}`);s.set("authorization",`Basic ${o}`)}}function B(e,t){const n=z()+C(t);return{jti:D(),aud:e.issuer,exp:n+60,iat:n,nbf:n,iss:t.client_id,sub:t.client_id}}function G(e,t){const{key:n,kid:a}=N(e);return g(n,'"clientPrivateKey.key"'),async(e,s,r,i)=>{const o={alg:I(n),kid:a},c=B(e,s);t?.[u]?.(o,c),r.set("client_id",s.client_id),r.set("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),r.set("client_assertion",await X(o,c,n))}}function Q(e,t){E(e,'"clientSecret"');const n=t?.[u];let a;return async(t,s,r,i)=>{a||=await crypto.subtle.importKey("raw",f(e),{hash:"SHA-256",name:"HMAC"},!1,["sign"]);const o={alg:"HS256"},c=B(t,s);n?.(o,c);const u=`${m(f(JSON.stringify(o)))}.${m(f(JSON.stringify(c)))}`,d=await crypto.subtle.sign(a.algorithm,a,f(u));r.set("client_id",s.client_id),r.set("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),r.set("client_assertion",`${u}.${m(new Uint8Array(d))}`)}}function Y(){return(e,t,n,a)=>{n.set("client_id",t.client_id)}}function Z(){return(e,t,n,a)=>{n.set("client_id",t.client_id)}}async function X(e,t,a){if(!a.usages.includes("sign"))throw s('CryptoKey instances used for signing assertions must include "sign" in their "usages"',n);const r=`${m(f(JSON.stringify(e)))}.${m(f(JSON.stringify(t)))}`;return`${r}.${m(await crypto.subtle.sign(Dt(a),a,f(r)))}`}async function ee(e,t,a,r,i){K(e),q(t),a=new URLSearchParams(a);const{key:o,kid:c}=N(r);g(o,'"privateKey.key"'),a.set("client_id",t.client_id);const d=z()+C(t),p={...Object.fromEntries(a.entries()),jti:D(),aud:e.issuer,exp:d+60,iat:d,nbf:d,iss:t.client_id};let h;a.has("resource")&&(h=a.getAll("resource"))&&h.length>1&&(p.resource=h);{let e=a.get("max_age");null!==e&&(p.max_age=parseInt(e,10),T(p.max_age,!0,'"max_age" parameter'))}{let e=a.get("claims");if(null!==e){try{p.claims=JSON.parse(e)}catch(e){throw _('failed to parse the "claims" parameter as JSON',it,e)}if(!S(p.claims))throw s('"claims" parameter must be a JSON with a top level object',n)}}{let e=a.get("authorization_details");if(null!==e){try{p.authorization_details=JSON.parse(e)}catch(e){throw _('failed to parse the "authorization_details" parameter as JSON',it,e)}if(!Array.isArray(p.authorization_details))throw s('"authorization_details" parameter must be a JSON with a top level array',n)}}const l={alg:I(o),typ:"oauth-authz-req+jwt",kid:c};return i?.[u]?.(l,p),X(l,p,o)}let te;async function ne(e){return te||=new WeakMap,te.get(e)||async function(e){const{kty:t,e:n,n:a,x:s,y:r,crv:i}=await crypto.subtle.exportKey("jwk",e),o={kty:t,e:n,n:a,x:s,y:r,crv:i};return te.set(e,o),o}(e)}const ae=URL.parse?(e,t)=>URL.parse(e,t):(e,t)=>{try{return new URL(e,t)}catch{return null}};function se(e,t){if(t&&"https:"!==e.protocol)throw _("only requests to HTTPS are allowed",pt,e);if("https:"!==e.protocol&&"http:"!==e.protocol)throw _("only HTTP and HTTPS requests are allowed",ht,e)}function re(e,t,n,a){let s;if("string"!=typeof e||!(s=ae(e)))throw _("authorization server metadata does not contain a valid "+(n?`"as.mtls_endpoint_aliases.${t}"`:`"as.${t}"`),void 0===e?wt:_t,{attribute:n?`mtls_endpoint_aliases.${t}`:t});return se(s,a),s}function ie(e,t,n,a){return n&&e.mtls_endpoint_aliases&&t in e.mtls_endpoint_aliases?re(e.mtls_endpoint_aliases[t],t,n,a):re(e[t],t,n,a)}async function oe(e,t,n,a,s){K(e),q(t);const i=ie(e,"pushed_authorization_request_endpoint",t.use_mtls_endpoint_aliases,!0!==s?.[r]),o=new URLSearchParams(a);o.set("client_id",t.client_id);const c=v(s?.headers);c.set("accept","application/json"),void 0!==s?.DPoP&&(ke(s.DPoP),await s.DPoP.addProof(i,c,"POST"));const u=await Le(e,t,n,i,o,c,s);return s?.DPoP?.cacheNonce(u),u}class ce{#e;#t;#n;#a;#s;#r;#i;constructor(e,t,a){if(g(t?.privateKey,'"DPoP.privateKey"'),function(e,t){if(b(e,t),"public"!==e.type)throw s(`${t} must be a public CryptoKey`,n)}(t?.publicKey,'"DPoP.publicKey"'),!t.publicKey.extractable)throw s('"DPoP.publicKey.extractable" must be true',n);this.#s=a?.[u],this.#a=C(e),this.#t=t.privateKey,this.#n=t.publicKey,Be.add(this)}#o(e){this.#r||=new Map;let t=this.#r.get(e);return t&&(this.#r.delete(e),this.#r.set(e,t)),t}#c(e,t){this.#r||=new Map,this.#r.delete(e),100===this.#r.size&&this.#r.delete(this.#r.keys().next().value),this.#r.set(e,t)}async calculateThumbprint(){if(!this.#i){const e=await crypto.subtle.exportKey("jwk",this.#n);let t;switch(e.kty){case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;default:throw new y("unsupported JWK",{cause:{jwk:e}})}this.#i||=m(await crypto.subtle.digest({name:"SHA-256"},f(JSON.stringify(t))))}return this.#i}async addProof(e,t,n,a){this.#e||={alg:I(this.#t),typ:"dpop+jwt",jwk:await ne(this.#n)};const s=this.#o(e.origin),r={iat:z()+this.#a,jti:D(),htm:n,nonce:s,htu:`${e.origin}${e.pathname}`,ath:a?m(await crypto.subtle.digest("SHA-256",f(a))):void 0};this.#s?.(this.#e,r),t.set("dpop",await X(this.#e,r,this.#t))}cacheNonce(e){try{const t=e.headers.get("dpop-nonce");t&&this.#c(new URL(e.url).origin,t)}catch{}}}function ue(e){if(e instanceof le){const{0:t,length:n}=e.cause;return 1===n&&"dpop"===t.scheme&&"use_dpop_nonce"===t.parameters.error}return e instanceof pe&&"use_dpop_nonce"===e.error}function de(e,t,n){return new ce(e,t,n)}class pe extends Error{cause;code;error;status;error_description;response;constructor(e,t){super(e,t),this.name=this.constructor.name,this.code=nt,this.cause=t.cause,this.error=t.cause.error,this.status=t.response.status,this.error_description=t.cause.error_description,Object.defineProperty(this,"response",{enumerable:!1,value:t.response}),Error.captureStackTrace?.(this,this.constructor)}}class he extends Error{cause;code;error;error_description;constructor(e,t){super(e,t),this.name=this.constructor.name,this.code=st,this.cause=t.cause,this.error=t.cause.get("error"),this.error_description=t.cause.get("error_description")??void 0,Error.captureStackTrace?.(this,this.constructor)}}class le extends Error{cause;code;response;status;constructor(e,t){super(e,t),this.name=this.constructor.name,this.code=tt,this.cause=t.cause,this.status=t.response.status,this.response=t.response,Object.defineProperty(this,"response",{enumerable:!1}),Error.captureStackTrace?.(this,this.constructor)}}const fe="[a-zA-Z0-9!#$%&\\'\\*\\+\\-\\.\\^_`\\|~]+",me="("+fe+')\\s*=\\s*"((?:[^"\\\\]|\\\\.)*)"',ye="("+fe+")\\s*=\\s*("+fe+")",we=new RegExp("^[,\\s]*("+fe+")\\s(.*)"),_e=new RegExp("^[,\\s]*"+me+"[,\\s]*(.*)"),be=new RegExp("^[,\\s]*"+ye+"[,\\s]*(.*)"),ge=new RegExp("^([a-zA-Z0-9\\-\\._\\~\\+\\/]+[=]{0,2})(?:$|[,\\s])(.*)");async function Se(e,n,r){if(K(e),q(n),!t(r,Response))throw s('"response" must be an instance of Response',a);ze(r),await ve(r,201,"Pushed Authorization Request Endpoint"),xt(r);const i=await hn(r);E(i.request_uri,'"response" body "request_uri" property',ot,{body:i});let o="number"!=typeof i.expires_in?parseFloat(i.expires_in):i.expires_in;return T(o,!1,'"response" body "expires_in" property',ot,{body:i}),i.expires_in=o,i}async function ve(e,t,n){if(e.status!==t){let t;if(t=await async function(e){if(e.status>399&&e.status<500){xt(e),O(e);try{const t=await e.clone().json();if(S(t)&&"string"==typeof t.error&&t.error.length)return t}catch{}}}(e))throw await(e.body?.cancel()),new pe("server responded with an error in the response body",{cause:t,response:e});throw _(`"response" is not a conform ${n} response (unexpected HTTP status code)`,dt,e)}}function ke(e){if(!Be.has(e))throw s('"options.DPoP" is not a valid DPoPHandle',n)}async function Pe(e,t,n,i,o,u){if(E(e,'"accessToken"'),!(n instanceof URL))throw s('"url" must be an instance of URL',a);se(n,!0!==u?.[r]),i=v(i),u?.DPoP&&(ke(u.DPoP),await u.DPoP.addProof(n,i,t.toUpperCase(),e)),i.set("authorization",`${i.has("dpop")?"DPoP":"Bearer"} ${e}`);const d=await(u?.[c]||fetch)(n.href,{body:o,headers:Object.fromEntries(i.entries()),method:t,redirect:"manual",signal:u?.signal?k(u.signal):void 0});return u?.DPoP?.cacheNonce(d),d}async function Re(e,t,n,a,s,r){const i=await Pe(e,t,n,a,s,r);return ze(i),i}async function xe(e,t,n,a){K(e),q(t);const s=ie(e,"userinfo_endpoint",t.use_mtls_endpoint_aliases,!0!==a?.[r]),o=v(a?.headers);return t.userinfo_signed_response_alg?o.set("accept","application/jwt"):(o.set("accept","application/json"),o.append("accept","application/jwt")),Pe(n,"GET",s,o,null,{...a,[i]:C(t)})}let Ae;function Te(e,t,n,a){Ae||=new WeakMap,Ae.set(e,{jwks:t,uat:n,get age(){return z()-this.uat}}),a&&Object.assign(a,{jwks:structuredClone(t),uat:n})}function Ee(e,t){Ae?.delete(e),delete t?.jwks,delete t?.uat}async function je(e,t,n){const{alg:a,kid:s}=n;var i;let o,u,d;if(function(e){if(!jt(e.alg))throw new y('unsupported JWS "alg" identifier',{cause:{alg:e.alg}})}(n),!Ae?.has(e)&&(i=t?.[p],"object"==typeof i&&null!==i&&"uat"in i&&"number"==typeof i.uat&&!(z()-i.uat>=300)&&"jwks"in i&&S(i.jwks)&&Array.isArray(i.jwks.keys)&&Array.prototype.every.call(i.jwks.keys,S))&&Te(e,t?.[p].jwks,t?.[p].uat),Ae?.has(e)){if(({jwks:o,age:u}=Ae.get(e)),u>=300)return Ee(e,t?.[p]),je(e,t,n)}else o=await async function(e,t){K(e);const n=ie(e,"jwks_uri",!1,!0!==t?.[r]),a=v(t?.headers);return a.set("accept","application/json"),a.append("accept","application/jwk-set+json"),(t?.[c]||fetch)(n.href,{body:void 0,headers:Object.fromEntries(a.entries()),method:"GET",redirect:"manual",signal:t?.signal?k(t.signal):void 0})}(e,t).then(Et),u=0,Te(e,o,z(),t?.[p]);switch(a.slice(0,2)){case"RS":case"PS":d="RSA";break;case"ES":d="EC";break;case"Ed":d="OKP";break;default:throw new y("unsupported JWS algorithm",{cause:{alg:a}})}const h=o.keys.filter((e=>{if(e.kty!==d)return!1;if(void 0!==s&&s!==e.kid)return!1;if(void 0!==e.alg&&a!==e.alg)return!1;if(void 0!==e.use&&"sig"!==e.use)return!1;if(!1===e.key_ops?.includes("verify"))return!1;switch(!0){case"ES256"===a&&"P-256"!==e.crv:case"ES384"===a&&"P-384"!==e.crv:case"ES512"===a&&"P-521"!==e.crv:case"Ed25519"===a&&"Ed25519"!==e.crv:case"EdDSA"===a&&"Ed25519"!==e.crv:return!1}return!0})),{0:l,length:f}=h;if(!f){if(u>=60)return Ee(e,t?.[p]),je(e,t,n);throw _("error when selecting a JWT verification key, no applicable keys found",yt,{header:n,candidates:h,jwks_uri:new URL(e.jwks_uri)})}if(1!==f)throw _('error when selecting a JWT verification key, multiple applicable keys found, a "kid" JWT Header Parameter is required',yt,{header:n,candidates:h,jwks_uri:new URL(e.jwks_uri)});return Bt(a,l)}const Oe=Symbol();function Ue(e){return e.headers.get("content-type")?.split(";")[0]}async function De(e,n,r,i,o){if(K(e),q(n),!t(i,Response))throw s('"response" must be an instance of Response',a);if(ze(i),200!==i.status)throw _('"response" is not a conform UserInfo Endpoint response (unexpected HTTP status code)',dt,i);let c;if(xt(i),"application/jwt"===Ue(i)){const{claims:t,jwt:a}=await Ht(await i.text(),zt.bind(void 0,n.userinfo_signed_response_alg,e.userinfo_signing_alg_values_supported,void 0),C(n),$(n),o?.[d]).then(qe.bind(void 0,n.client_id)).then(Fe.bind(void 0,e));Ne.set(i,a),c=t}else{if(n.userinfo_signed_response_alg)throw _("JWT UserInfo Response expected",rt,i);c=await hn(i)}if(E(c.sub,'"response" body "sub" property',ot,{body:c}),r===Oe);else if(E(r,'"expectedSubject"'),c.sub!==r)throw _('unexpected "response" body "sub" property value',mt,{expected:r,body:c,attribute:"sub"});return c}async function Le(e,t,n,a,s,r,i){return await n(e,t,s,r),r.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"),(i?.[c]||fetch)(a.href,{body:s,headers:Object.fromEntries(r.entries()),method:"POST",redirect:"manual",signal:i?.signal?k(i.signal):void 0})}async function He(e,t,n,a,s,i){const o=ie(e,"token_endpoint",t.use_mtls_endpoint_aliases,!0!==i?.[r]);s.set("grant_type",a);const c=v(i?.headers);c.set("accept","application/json"),void 0!==i?.DPoP&&(ke(i.DPoP),await i.DPoP.addProof(o,c,"POST"));const u=await Le(e,t,n,o,s,c,i);return i?.DPoP?.cacheNonce(u),u}async function Je(e,t,n,a,s){K(e),q(t),E(a,'"refreshToken"');const r=new URLSearchParams(s?.additionalParameters);return r.set("refresh_token",a),He(e,t,n,"refresh_token",r,s)}const We=new WeakMap,Ne=new WeakMap;function Ie(e){if(!e.id_token)return;const t=We.get(e);if(!t)throw s('"ref" was already garbage collected or did not resolve from the proper sources',n);return t}async function Ce(e,t,a){if(K(e),!Ne.has(t))throw s('"ref" does not contain a processed JWT Response to verify the signature of',n);const{0:r,1:i,2:o}=Ne.get(t).split("."),c=JSON.parse(f(m(r)));if(c.alg.startsWith("HS"))throw new y("unsupported JWS algorithm",{cause:{alg:c.alg}});let u;u=await je(e,a,c),await Lt(r,i,u,m(o))}async function $e(e,n,r,i,o){if(K(e),q(n),!t(r,Response))throw s('"response" must be an instance of Response',a);ze(r),await ve(r,200,"Token Endpoint"),xt(r);const c=await hn(r);if(E(c.access_token,'"response" body "access_token" property',ot,{body:c}),E(c.token_type,'"response" body "token_type" property',ot,{body:c}),c.token_type=c.token_type.toLowerCase(),"dpop"!==c.token_type&&"bearer"!==c.token_type)throw new y("unsupported `token_type` value",{cause:{body:c}});if(void 0!==c.expires_in){let e="number"!=typeof c.expires_in?parseFloat(c.expires_in):c.expires_in;T(e,!1,'"response" body "expires_in" property',ot,{body:c}),c.expires_in=e}if(void 0!==c.refresh_token&&E(c.refresh_token,'"response" body "refresh_token" property',ot,{body:c}),void 0!==c.scope&&"string"!=typeof c.scope)throw _('"response" body "scope" property must be a string',ot,{body:c});if(void 0!==c.id_token){E(c.id_token,'"response" body "id_token" property',ot,{body:c});const t=["aud","exp","iat","iss","sub"];!0===n.require_auth_time&&t.push("auth_time"),void 0!==n.default_max_age&&(T(n.default_max_age,!1,'"client.default_max_age"'),t.push("auth_time")),i?.length&&t.push(...i);const{claims:a,jwt:s}=await Ht(c.id_token,zt.bind(void 0,n.id_token_signed_response_alg,e.id_token_signing_alg_values_supported,"RS256"),C(n),$(n),o?.[d]).then(Ye.bind(void 0,t)).then(Ve.bind(void 0,e)).then(Me.bind(void 0,n.client_id));if(Array.isArray(a.aud)&&1!==a.aud.length){if(void 0===a.azp)throw _('ID Token "aud" (audience) claim includes additional untrusted audiences',ft,{claims:a,claim:"aud"});if(a.azp!==n.client_id)throw _('unexpected ID Token "azp" (authorized party) claim value',ft,{expected:n.client_id,claims:a,claim:"azp"})}void 0!==a.auth_time&&T(a.auth_time,!1,'ID Token "auth_time" (authentication time)',ot,{claims:a}),Ne.set(r,s),We.set(c,a)}return c}function ze(e){let n;if(n=function(e){if(!t(e,Response))throw s('"response" must be an instance of Response',a);const n=e.headers.get("www-authenticate");if(null===n)return;const r=[];let i=n;for(;i;){let e=i.match(we);const t=e?.[1].toLowerCase();if(i=e?.[2],!t)return;const n={};let a;for(;i;){let t,s;if(e=i.match(_e)){if([,t,s,i]=e,s.includes("\\"))try{s=JSON.parse(`"${s}"`)}catch{}n[t.toLowerCase()]=s}else{if(!(e=i.match(be))){if(e=i.match(ge)){if(Object.keys(n).length)break;[,a,i]=e;break}return}[,t,s,i]=e,n[t.toLowerCase()]=s}}const s={scheme:t,parameters:n};a&&(s.token68=a),r.push(s)}return r.length?r:void 0}(e))throw new le("server responded with a challenge in the WWW-Authenticate HTTP Header",{cause:n,response:e})}async function Ke(e,t,n,a){return $e(e,t,n,void 0,a)}function qe(e,t){return void 0!==t.claims.aud?Me(e,t):t}function Me(e,t){if(Array.isArray(t.claims.aud)){if(!t.claims.aud.includes(e))throw _('unexpected JWT "aud" (audience) claim value',ft,{expected:e,claims:t.claims,claim:"aud"})}else if(t.claims.aud!==e)throw _('unexpected JWT "aud" (audience) claim value',ft,{expected:e,claims:t.claims,claim:"aud"});return t}function Fe(e,t){return void 0!==t.claims.iss?Ve(e,t):t}function Ve(e,t){const n=e[mn]?.(t)??e.issuer;if(t.claims.iss!==n)throw _('unexpected JWT "iss" (issuer) claim value',ft,{expected:n,claims:t.claims,claim:"iss"});return t}const Be=new WeakSet;async function Ge(e,t,a,r,i,o,c){if(K(e),q(t),!Be.has(r))throw s('"callbackParameters" must be an instance of URLSearchParams obtained from "validateAuthResponse()", or "validateJwtAuthResponse()',n);E(i,'"redirectUri"');const u=Kt(r,"code");if(!u)throw _('no authorization code in "callbackParameters"',ot);const d=new URLSearchParams(c?.additionalParameters);return d.set("redirect_uri",i),d.set("code",u),o!==ln&&(E(o,'"codeVerifier"'),d.set("code_verifier",o)),He(e,t,a,"authorization_code",d,c)}const Qe={aud:"audience",c_hash:"code hash",client_id:"client id",exp:"expiration time",iat:"issued at",iss:"issuer",jti:"jwt id",nonce:"nonce",s_hash:"state hash",sub:"subject",ath:"access token hash",htm:"http method",htu:"http uri",cnf:"confirmation",auth_time:"authentication time"};function Ye(e,t){for(const n of e)if(void 0===t.claims[n])throw _(`JWT "${n}" (${Qe[n]}) claim missing`,ot,{claims:t.claims});return t}const Ze=Symbol(),Xe=Symbol();async function et(e,t,n,a){return"string"==typeof a?.expectedNonce||"number"==typeof a?.maxAge||a?.requireIdToken?async function(e,t,n,a,s,r){const i=[];switch(a){case void 0:a=Ze;break;case Ze:break;default:E(a,'"expectedNonce" argument'),i.push("nonce")}switch(s??=t.default_max_age,s){case void 0:s=Xe;break;case Xe:break;default:T(s,!1,'"maxAge" argument'),i.push("auth_time")}const o=await $e(e,t,n,i,r);E(o.id_token,'"response" body "id_token" property',ot,{body:o});const c=Ie(o);if(s!==Xe){const e=z()+C(t),n=$(t);if(c.auth_time+s<e-n)throw _("too much time has elapsed since the last End-User authentication",lt,{claims:c,now:e,tolerance:n,claim:"auth_time"})}if(a===Ze){if(void 0!==c.nonce)throw _('unexpected ID Token "nonce" claim value',ft,{expected:void 0,claims:c,claim:"nonce"})}else if(c.nonce!==a)throw _('unexpected ID Token "nonce" claim value',ft,{expected:a,claims:c,claim:"nonce"});return o}(e,t,n,a.expectedNonce,a.maxAge,{[d]:a[d]}):async function(e,t,n,a){const s=await $e(e,t,n,void 0,a),r=Ie(s);if(r){if(void 0!==t.default_max_age){T(t.default_max_age,!1,'"client.default_max_age"');const e=z()+C(t),n=$(t);if(r.auth_time+t.default_max_age<e-n)throw _("too much time has elapsed since the last End-User authentication",lt,{claims:r,now:e,tolerance:n,claim:"auth_time"})}if(void 0!==r.nonce)throw _('unexpected ID Token "nonce" claim value',ft,{expected:void 0,claims:r,claim:"nonce"})}return s}(e,t,n,a)}const tt="OAUTH_WWW_AUTHENTICATE_CHALLENGE",nt="OAUTH_RESPONSE_BODY_ERROR",at="OAUTH_UNSUPPORTED_OPERATION",st="OAUTH_AUTHORIZATION_RESPONSE_ERROR",rt="OAUTH_JWT_USERINFO_EXPECTED",it="OAUTH_PARSE_ERROR",ot="OAUTH_INVALID_RESPONSE",ct="OAUTH_INVALID_REQUEST",ut="OAUTH_RESPONSE_IS_NOT_JSON",dt="OAUTH_RESPONSE_IS_NOT_CONFORM",pt="OAUTH_HTTP_REQUEST_FORBIDDEN",ht="OAUTH_REQUEST_PROTOCOL_FORBIDDEN",lt="OAUTH_JWT_TIMESTAMP_CHECK_FAILED",ft="OAUTH_JWT_CLAIM_COMPARISON_FAILED",mt="OAUTH_JSON_ATTRIBUTE_COMPARISON_FAILED",yt="OAUTH_KEY_SELECTION_FAILED",wt="OAUTH_MISSING_SERVER_METADATA",_t="OAUTH_INVALID_SERVER_METADATA";function bt(e,t){if("string"!=typeof t.header.typ||t.header.typ.toLowerCase().replace(/^application\//,"")!==e)throw _('unexpected JWT "typ" header parameter value',ot,{header:t.header});return t}async function gt(e,t,n,a,s){return K(e),q(t),He(e,t,n,"client_credentials",new URLSearchParams(a),s)}async function St(e,t,n,a,s,r){return K(e),q(t),E(a,'"grantType"'),He(e,t,n,a,new URLSearchParams(s),r)}async function vt(e,t,n,a){return $e(e,t,n,void 0,a)}async function kt(e,t,n,a){return $e(e,t,n,void 0,a)}async function Pt(e,t,n,a,s){K(e),q(t),E(a,'"token"');const i=ie(e,"revocation_endpoint",t.use_mtls_endpoint_aliases,!0!==s?.[r]),o=new URLSearchParams(s?.additionalParameters);o.set("token",a);const c=v(s?.headers);return c.delete("accept"),Le(e,t,n,i,o,c,s)}async function Rt(e){if(!t(e,Response))throw s('"response" must be an instance of Response',a);ze(e),await ve(e,200,"Revocation Endpoint")}function xt(e){if(e.bodyUsed)throw s('"response" body has been used already',n)}async function At(e,t,n,a,s){K(e),q(t),E(a,'"token"');const i=ie(e,"introspection_endpoint",t.use_mtls_endpoint_aliases,!0!==s?.[r]),o=new URLSearchParams(s?.additionalParameters);o.set("token",a);const c=v(s?.headers);return s?.requestJwtResponse??t.introspection_signed_response_alg?c.set("accept","application/token-introspection+jwt"):c.set("accept","application/json"),Le(e,t,n,i,o,c,s)}async function Tt(e,n,r,i){if(K(e),q(n),!t(r,Response))throw s('"response" must be an instance of Response',a);let o;if(ze(r),await ve(r,200,"Introspection Endpoint"),"application/token-introspection+jwt"===Ue(r)){xt(r);const{claims:t,jwt:a}=await Ht(await r.text(),zt.bind(void 0,n.introspection_signed_response_alg,e.introspection_signing_alg_values_supported,"RS256"),C(n),$(n),i?.[d]).then(bt.bind(void 0,"token-introspection+jwt")).then(Ye.bind(void 0,["aud","iat","iss"])).then(Ve.bind(void 0,e)).then(Me.bind(void 0,n.client_id));if(Ne.set(r,a),!S(t.token_introspection))throw _('JWT "token_introspection" claim must be a JSON object',ot,{claims:t});o=t.token_introspection}else xt(r),o=await hn(r);if("boolean"!=typeof o.active)throw _('"response" body "active" property must be a boolean',ot,{body:o});return o}async function Et(e){if(!t(e,Response))throw s('"response" must be an instance of Response',a);if(200!==e.status)throw _('"response" is not a conform JSON Web Key Set response (unexpected HTTP status code)',dt,e);xt(e);const n=await hn(e,(e=>function(e,...t){if(!t.includes(Ue(e)))throw U(e,...t)}(e,"application/json","application/jwk-set+json")));if(!Array.isArray(n.keys))throw _('"response" body "keys" property must be an array',ot,{body:n});if(!Array.prototype.every.call(n.keys,S))throw _('"response" body "keys" property members must be JWK formatted objects',ot,{body:n});return n}function jt(e){switch(e){case"PS256":case"ES256":case"RS256":case"PS384":case"ES384":case"RS384":case"PS512":case"ES512":case"RS512":case"Ed25519":case"EdDSA":return!0;default:return!1}}function Ot(e){const{algorithm:t}=e;if("number"!=typeof t.modulusLength||t.modulusLength<2048)throw new y(`unsupported ${t.name} modulusLength`,{cause:e})}function Ut(e){const{algorithm:t}=e;switch(t.namedCurve){case"P-256":return"SHA-256";case"P-384":return"SHA-384";case"P-521":return"SHA-512";default:throw new y("unsupported ECDSA namedCurve",{cause:e})}}function Dt(e){switch(e.algorithm.name){case"ECDSA":return{name:e.algorithm.name,hash:Ut(e)};case"RSA-PSS":switch(Ot(e),e.algorithm.hash.name){case"SHA-256":case"SHA-384":case"SHA-512":return{name:e.algorithm.name,saltLength:parseInt(e.algorithm.hash.name.slice(-3),10)>>3};default:throw new y("unsupported RSA-PSS hash name",{cause:e})}case"RSASSA-PKCS1-v1_5":return Ot(e),e.algorithm.name;case"Ed25519":return e.algorithm.name}throw new y("unsupported CryptoKey algorithm name",{cause:e})}async function Lt(e,t,n,a){const s=f(`${e}.${t}`),r=Dt(n);if(!await crypto.subtle.verify(r,n,a,s))throw _("JWT signature verification failed",ot,{key:n,data:s,signature:a,algorithm:r})}async function Ht(e,t,n,a,s){let r,i,{0:o,1:c,length:u}=e.split(".");if(5===u){if(void 0===s)throw new y("JWE decryption is not configured",{cause:e});e=await s(e),({0:o,1:c,length:u}=e.split("."))}if(3!==u)throw _("Invalid JWT",ot,e);try{r=JSON.parse(f(m(o)))}catch(e){throw _("failed to parse JWT Header body as base64url encoded JSON",it,e)}if(!S(r))throw _("JWT Header must be a top level object",ot,e);if(t(r),void 0!==r.crit)throw new y('no JWT "crit" header parameter extensions are supported',{cause:{header:r}});try{i=JSON.parse(f(m(c)))}catch(e){throw _("failed to parse JWT Payload body as base64url encoded JSON",it,e)}if(!S(i))throw _("JWT Payload must be a top level object",ot,e);const d=z()+n;if(void 0!==i.exp){if("number"!=typeof i.exp)throw _('unexpected JWT "exp" (expiration time) claim type',ot,{claims:i});if(i.exp<=d-a)throw _('unexpected JWT "exp" (expiration time) claim value, expiration is past current timestamp',lt,{claims:i,now:d,tolerance:a,claim:"exp"})}if(void 0!==i.iat&&"number"!=typeof i.iat)throw _('unexpected JWT "iat" (issued at) claim type',ot,{claims:i});if(void 0!==i.iss&&"string"!=typeof i.iss)throw _('unexpected JWT "iss" (issuer) claim type',ot,{claims:i});if(void 0!==i.nbf){if("number"!=typeof i.nbf)throw _('unexpected JWT "nbf" (not before) claim type',ot,{claims:i});if(i.nbf>d+a)throw _('unexpected JWT "nbf" (not before) claim value',lt,{claims:i,now:d,tolerance:a,claim:"nbf"})}if(void 0!==i.aud&&"string"!=typeof i.aud&&!Array.isArray(i.aud))throw _('unexpected JWT "aud" (audience) claim type',ot,{claims:i});return{header:r,claims:i,jwt:e}}async function Jt(e,t,n,r,i){if(K(e),q(t),n instanceof URL&&(n=n.searchParams),!(n instanceof URLSearchParams))throw s('"parameters" must be an instance of URLSearchParams, or URL',a);const o=Kt(n,"response");if(!o)throw _('"parameters" does not contain a JARM response',ot);const{claims:c,header:u,jwt:p}=await Ht(o,zt.bind(void 0,t.authorization_signed_response_alg,e.authorization_signing_alg_values_supported,"RS256"),C(t),$(t),i?.[d]).then(Ye.bind(void 0,["aud","exp","iss"])).then(Ve.bind(void 0,e)).then(Me.bind(void 0,t.client_id)),{0:h,1:l,2:f}=p.split("."),y=m(f),w=await je(e,i,u);await Lt(h,l,w,y);const b=new URLSearchParams;for(const[e,t]of Object.entries(c))"string"==typeof t&&"aud"!==e&&b.set(e,t);return Ft(e,t,b,r)}async function Wt(e,t,n,a){const s=await async function(e,t,n){let a;switch(t.alg){case"RS256":case"PS256":case"ES256":a="SHA-256";break;case"RS384":case"PS384":case"ES384":a="SHA-384";break;case"RS512":case"PS512":case"ES512":case"Ed25519":case"EdDSA":a="SHA-512";break;default:throw new y(`unsupported JWS algorithm for ${n} calculation`,{cause:{alg:t.alg}})}const s=await crypto.subtle.digest(a,f(e));return m(s.slice(0,s.byteLength/2))}(e,n,a);return t===s}async function Nt(e,t,n,a,s,r,i){return $t(e,t,n,a,s,r,i,!0)}async function It(e,t,n,a,s,r,i){return $t(e,t,n,a,s,r,i,!1)}async function Ct(e){if("POST"!==e.method)throw s("form_post responses are expected to use the POST method",n,{cause:e});if("application/x-www-form-urlencoded"!==Ue(e))throw s("form_post responses are expected to use the application/x-www-form-urlencoded content-type",n,{cause:e});return async function(e){if(e.bodyUsed)throw s("form_post Request instances must contain a readable body",n,{cause:e});return e.text()}(e)}async function $t(e,r,i,o,c,u,p,h){if(K(e),q(r),i instanceof URL){if(!i.hash.length)throw s('"parameters" as an instance of URL must contain a hash (fragment) with the Authorization Response parameters',n);i=new URLSearchParams(i.hash.slice(1))}else if(t(i,Request))i=new URLSearchParams(await Ct(i));else{if(!(i instanceof URLSearchParams))throw s('"parameters" must be an instance of URLSearchParams, URL, or Response',a);i=new URLSearchParams(i)}const l=Kt(i,"id_token");switch(i.delete("id_token"),c){case void 0:case Mt:break;default:E(c,'"expectedState" argument')}const f=Ft({...e,authorization_response_iss_parameter_supported:!1},r,i,c);if(!l)throw _('"parameters" does not contain an ID Token',ot);const y=Kt(i,"code");if(!y)throw _('"parameters" does not contain an Authorization Code',ot);const w=["aud","exp","iat","iss","sub","nonce","c_hash"],b=i.get("state");!h||"string"!=typeof c&&null===b||w.push("s_hash"),void 0!==u?T(u,!1,'"maxAge" argument'):void 0!==r.default_max_age&&T(r.default_max_age,!1,'"client.default_max_age"'),u??=r.default_max_age??Xe,(r.require_auth_time||u!==Xe)&&w.push("auth_time");const{claims:g,header:S,jwt:v}=await Ht(l,zt.bind(void 0,r.id_token_signed_response_alg,e.id_token_signing_alg_values_supported,"RS256"),C(r),$(r),p?.[d]).then(Ye.bind(void 0,w)).then(Ve.bind(void 0,e)).then(Me.bind(void 0,r.client_id)),k=C(r),P=z()+k;if(g.iat<P-3600)throw _('unexpected JWT "iat" (issued at) claim value, it is too far in the past',lt,{now:P,claims:g,claim:"iat"});if(E(g.c_hash,'ID Token "c_hash" (code hash) claim value',ot,{claims:g}),void 0!==g.auth_time&&T(g.auth_time,!1,'ID Token "auth_time" (authentication time)',ot,{claims:g}),u!==Xe){const e=z()+C(r),t=$(r);if(g.auth_time+u<e-t)throw _("too much time has elapsed since the last End-User authentication",lt,{claims:g,now:e,tolerance:t,claim:"auth_time"})}if(E(o,'"expectedNonce" argument'),g.nonce!==o)throw _('unexpected ID Token "nonce" claim value',ft,{expected:o,claims:g,claim:"nonce"});if(Array.isArray(g.aud)&&1!==g.aud.length){if(void 0===g.azp)throw _('ID Token "aud" (audience) claim includes additional untrusted audiences',ft,{claims:g,claim:"aud"});if(g.azp!==r.client_id)throw _('unexpected ID Token "azp" (authorized party) claim value',ft,{expected:r.client_id,claims:g,claim:"azp"})}const{0:R,1:x,2:A}=v.split("."),j=m(A),O=await je(e,p,S);if(await Lt(R,x,O,j),!0!==await Wt(y,g.c_hash,S,"c_hash"))throw _('invalid ID Token "c_hash" (code hash) claim value',ft,{code:y,alg:S.alg,claim:"c_hash",claims:g});if((h&&null!==b||void 0!==g.s_hash)&&(E(g.s_hash,'ID Token "s_hash" (state hash) claim value',ot,{claims:g}),E(b,'"state" response parameter',ot,{parameters:i}),!0!==await Wt(b,g.s_hash,S,"s_hash")))throw _('invalid ID Token "s_hash" (state hash) claim value',ft,{state:b,alg:S.alg,claim:"s_hash",claims:g});return f}function zt(e,t,n,a){if(void 0===e)if(Array.isArray(t)){if(!t.includes(a.alg))throw _('unexpected JWT "alg" header parameter',ot,{header:a,expected:t,reason:"authorization server metadata"})}else{if(void 0===n)throw _('missing client or server configuration to verify used JWT "alg" header parameter',void 0,{client:e,issuer:t,fallback:n});if("string"==typeof n?a.alg!==n:"function"==typeof n?!n(a.alg):!n.includes(a.alg))throw _('unexpected JWT "alg" header parameter',ot,{header:a,expected:n,reason:"default value"})}else if("string"==typeof e?a.alg!==e:!e.includes(a.alg))throw _('unexpected JWT "alg" header parameter',ot,{header:a,expected:e,reason:"client configuration"})}function Kt(e,t){const{0:n,length:a}=e.getAll(t);if(a>1)throw _(`"${t}" parameter must be provided only once`,ot);return n}const qt=Symbol(),Mt=Symbol();function Ft(e,t,n,r){if(K(e),q(t),n instanceof URL&&(n=n.searchParams),!(n instanceof URLSearchParams))throw s('"parameters" must be an instance of URLSearchParams, or URL',a);if(Kt(n,"response"))throw _('"parameters" contains a JARM response, use validateJwtAuthResponse() instead of validateAuthResponse()',ot,{parameters:n});const i=Kt(n,"iss"),o=Kt(n,"state");if(!i&&e.authorization_response_iss_parameter_supported)throw _('response parameter "iss" (issuer) missing',ot,{parameters:n});if(i&&i!==e.issuer)throw _('unexpected "iss" (issuer) response parameter value',ot,{expected:e.issuer,parameters:n});switch(r){case void 0:case Mt:if(void 0!==o)throw _('unexpected "state" response parameter encountered',ot,{expected:void 0,parameters:n});break;case qt:break;default:if(E(r,'"expectedState" argument'),o!==r)throw _(void 0===o?'response parameter "state" missing':'unexpected "state" response parameter value',ot,{expected:r,parameters:n})}if(Kt(n,"error"))throw new he("authorization response from the server is an error",{cause:n});const c=Kt(n,"id_token"),u=Kt(n,"token");if(void 0!==c||void 0!==u)throw new y("implicit and hybrid flows are not supported");return d=new URLSearchParams(n),Be.add(d),d;var d}function Vt(e){switch(e){case"PS256":case"PS384":case"PS512":return{name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`};case"RS256":case"RS384":case"RS512":return{name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`};case"ES256":case"ES384":return{name:"ECDSA",namedCurve:`P-${e.slice(-3)}`};case"ES512":return{name:"ECDSA",namedCurve:"P-521"};case"Ed25519":case"EdDSA":return"Ed25519";default:throw new y("unsupported JWS algorithm",{cause:{alg:e}})}}async function Bt(e,t){const{ext:n,key_ops:a,use:s,...r}=t;return crypto.subtle.importKey("jwk",r,Vt(e),!0,["verify"])}async function Gt(e,t,n,a,s){K(e),q(t);const i=ie(e,"device_authorization_endpoint",t.use_mtls_endpoint_aliases,!0!==s?.[r]),o=new URLSearchParams(a);o.set("client_id",t.client_id);const c=v(s?.headers);return c.set("accept","application/json"),Le(e,t,n,i,o,c,s)}async function Qt(e,n,r){if(K(e),q(n),!t(r,Response))throw s('"response" must be an instance of Response',a);ze(r),await ve(r,200,"Device Authorization Endpoint"),xt(r);const i=await hn(r);E(i.device_code,'"response" body "device_code" property',ot,{body:i}),E(i.user_code,'"response" body "user_code" property',ot,{body:i}),E(i.verification_uri,'"response" body "verification_uri" property',ot,{body:i});let o="number"!=typeof i.expires_in?parseFloat(i.expires_in):i.expires_in;return T(o,!1,'"response" body "expires_in" property',ot,{body:i}),i.expires_in=o,void 0!==i.verification_uri_complete&&E(i.verification_uri_complete,'"response" body "verification_uri_complete" property',ot,{body:i}),void 0!==i.interval&&T(i.interval,!1,'"response" body "interval" property',ot,{body:i}),i}async function Yt(e,t,n,a,s){K(e),q(t),E(a,'"deviceCode"');const r=new URLSearchParams(s?.additionalParameters);return r.set("device_code",a),He(e,t,n,"urn:ietf:params:oauth:grant-type:device_code",r,s)}async function Zt(e,t,n,a){return $e(e,t,n,void 0,a)}async function Xt(e,t){E(e,'"alg"');const n=Vt(e);return(e.startsWith("PS")||e.startsWith("RS"))&&Object.assign(n,{modulusLength:t?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])}),crypto.subtle.generateKey(n,t?.extractable??!1,["sign","verify"])}function en(e){const t=new URL(e);return t.search="",t.hash="",t.href}async function tn(e,n,r,i){if(K(e),!t(n,Request))throw s('"request" must be an instance of Request',a);E(r,'"expectedAudience"');const o=n.headers.get("authorization");if(null===o)throw _('"request" is missing an Authorization HTTP Header',ct,{headers:n.headers});let{0:c,1:u,length:d}=o.split(" ");switch(c=c.toLowerCase(),c){case"dpop":case"bearer":break;default:throw new y("unsupported Authorization HTTP Header scheme",{cause:{headers:n.headers}})}if(2!==d)throw _("invalid Authorization HTTP Header format",ct,{headers:n.headers});const p=["iss","exp","aud","sub","iat","jti","client_id"];(i?.requireDPoP||"dpop"===c||n.headers.has("dpop"))&&p.push("cnf");const{claims:h,header:l}=await Ht(u,zt.bind(void 0,i?.signingAlgorithms,void 0,jt),C(i),$(i),void 0).then(bt.bind(void 0,"at+jwt")).then(Ye.bind(void 0,p)).then(Ve.bind(void 0,e)).then(Me.bind(void 0,r)).catch(nn);for(const e of["client_id","jti","sub"])if("string"!=typeof h[e])throw _(`unexpected JWT "${e}" claim type`,ct,{claims:h});if("cnf"in h){if(!S(h.cnf))throw _('unexpected JWT "cnf" (confirmation) claim value',ct,{claims:h});const{0:e,length:t}=Object.keys(h.cnf);if(t){if(1!==t)throw new y("multiple confirmation claims are not supported",{cause:{claims:h}});if("jkt"!==e)throw new y("unsupported JWT Confirmation method",{cause:{claims:h}})}}const{0:w,1:b,2:g}=u.split("."),v=m(g),k=await je(e,i,l);return await Lt(w,b,k,v),(i?.requireDPoP||"dpop"===c||void 0!==h.cnf?.jkt||n.headers.has("dpop"))&&await async function(e,t,n,a){const s=e.headers.get("dpop");if(null===s)throw _("operation indicated DPoP use but the request has no DPoP HTTP Header",ct,{headers:e.headers});if(!1===e.headers.get("authorization")?.toLowerCase().startsWith("dpop "))throw _("operation indicated DPoP use but the request's Authorization HTTP Header scheme is not DPoP",ct,{headers:e.headers});if("string"!=typeof n.cnf?.jkt)throw _("operation indicated DPoP use but the JWT Access Token has no jkt confirmation claim",ct,{claims:n});const r=C(a),i=await Ht(s,zt.bind(void 0,a?.signingAlgorithms,void 0,jt),r,$(a),void 0).then(bt.bind(void 0,"dpop+jwt")).then(Ye.bind(void 0,["iat","jti","ath","htm","htu"])),o=z()+r;if(Math.abs(o-i.claims.iat)>300)throw _("DPoP Proof iat is not recent enough",lt,{now:o,claims:i.claims,claim:"iat"});if(i.claims.htm!==e.method)throw _("DPoP Proof htm mismatch",ft,{expected:e.method,claims:i.claims,claim:"htm"});if("string"!=typeof i.claims.htu||en(i.claims.htu)!==en(e.url))throw _("DPoP Proof htu mismatch",ft,{expected:en(e.url),claims:i.claims,claim:"htu"});{const e=m(await crypto.subtle.digest("SHA-256",f(t)));if(i.claims.ath!==e)throw _("DPoP Proof ath mismatch",ft,{expected:e,claims:i.claims,claim:"ath"})}{let e;switch(i.header.jwk.kty){case"EC":e={crv:i.header.jwk.crv,kty:i.header.jwk.kty,x:i.header.jwk.x,y:i.header.jwk.y};break;case"OKP":e={crv:i.header.jwk.crv,kty:i.header.jwk.kty,x:i.header.jwk.x};break;case"RSA":e={e:i.header.jwk.e,kty:i.header.jwk.kty,n:i.header.jwk.n};break;default:throw new y("unsupported JWK key type",{cause:i.header.jwk})}const t=m(await crypto.subtle.digest("SHA-256",f(JSON.stringify(e))));if(n.cnf.jkt!==t)throw _("JWT Access Token confirmation mismatch",ft,{expected:t,claims:n,claim:"cnf.jkt"})}const{0:c,1:u,2:d}=s.split("."),p=m(d),{jwk:h,alg:l}=i.header;if(!h)throw _("DPoP Proof is missing the jwk header parameter",ct,{header:i.header});const w=await Bt(l,h);if("public"!==w.type)throw _("DPoP Proof jwk header parameter must contain a public key",ct,{header:i.header});await Lt(c,u,w,p)}(n,u,h,i).catch(nn),h}function nn(e){throw e instanceof w&&e?.code===ct&&(e.code=ot),e}async function an(e,t,n,a,s){K(e),q(t);const i=ie(e,"backchannel_authentication_endpoint",t.use_mtls_endpoint_aliases,!0!==s?.[r]),o=new URLSearchParams(a);o.set("client_id",t.client_id);const c=v(s?.headers);return c.set("accept","application/json"),Le(e,t,n,i,o,c,s)}async function sn(e,n,r){if(K(e),q(n),!t(r,Response))throw s('"response" must be an instance of Response',a);ze(r),await ve(r,200,"Backchannel Authentication Endpoint"),xt(r);const i=await hn(r);E(i.auth_req_id,'"response" body "auth_req_id" property',ot,{body:i});let o="number"!=typeof i.expires_in?parseFloat(i.expires_in):i.expires_in;return T(o,!1,'"response" body "expires_in" property',ot,{body:i}),i.expires_in=o,void 0!==i.interval&&T(i.interval,!1,'"response" body "interval" property',ot,{body:i}),i}async function rn(e,t,n,a,s){K(e),q(t),E(a,'"authReqId"');const r=new URLSearchParams(s?.additionalParameters);return r.set("auth_req_id",a),He(e,t,n,"urn:openid:params:grant-type:ciba",r,s)}async function on(e,t,n,a){return $e(e,t,n,void 0,a)}async function cn(e,t,n){K(e);const a=ie(e,"registration_endpoint",t.use_mtls_endpoint_aliases,!0!==n?.[r]),s=v(n?.headers);s.set("accept","application/json"),s.set("content-type","application/json");const i="POST";n?.DPoP&&(ke(n.DPoP),await n.DPoP.addProof(a,s,i,n.initialAccessToken)),n?.initialAccessToken&&s.set("authorization",`${s.has("dpop")?"DPoP":"Bearer"} ${n.initialAccessToken}`);const o=await(n?.[c]||fetch)(a.href,{body:JSON.stringify(t),headers:Object.fromEntries(s.entries()),method:i,redirect:"manual",signal:n?.signal?k(n.signal):void 0});return n?.DPoP?.cacheNonce(o),o}async function un(e){if(!t(e,Response))throw s('"response" must be an instance of Response',a);ze(e),await ve(e,201,"Dynamic Client Registration Endpoint"),xt(e);const n=await hn(e);return E(n.client_id,'"response" body "client_id" property',ot,{body:n}),void 0!==n.client_secret&&E(n.client_secret,'"response" body "client_secret" property',ot,{body:n}),n.client_secret&&T(n.client_secret_expires_at,!0,'"response" body "client_secret_expires_at" property',ot,{body:n}),n}async function dn(e,t){return x(e,"resourceIdentifier",(e=>(R(e,".well-known/oauth-protected-resource"),e)),t)}async function pn(e,n){const r=e;if(!(r instanceof URL)&&r!==fn)throw s('"expectedResourceIdentifier" must be an instance of URL',a);if(!t(n,Response))throw s('"response" must be an instance of Response',a);if(200!==n.status)throw _('"response" is not a conform Resource Server Metadata response (unexpected HTTP status code)',dt,n);xt(n);const i=await hn(n);if(E(i.resource,'"response" body "resource" property',ot,{body:i}),r!==fn&&new URL(i.resource).href!==r.href)throw _('"response" body "resource" property does not match the expected value',mt,{expected:r.href,body:i,attribute:"resource"});return i}async function hn(e,t=O){let n;try{n=await e.json()}catch(n){throw t(e),_('failed to parse "response" body as JSON',it,n)}if(!S(n))throw _('"response" body must be a top level object',ot,{body:n});return n}const ln=Symbol(),fn=Symbol(),mn=Symbol();export{st as AUTHORIZATION_RESPONSE_ERROR,he as AuthorizationResponseError,V as ClientSecretBasic,Q as ClientSecretJwt,F as ClientSecretPost,de as DPoP,pt as HTTP_REQUEST_FORBIDDEN,ct as INVALID_REQUEST,ot as INVALID_RESPONSE,_t as INVALID_SERVER_METADATA,mt as JSON_ATTRIBUTE_COMPARISON,ft as JWT_CLAIM_COMPARISON,lt as JWT_TIMESTAMP_CHECK,rt as JWT_USERINFO_EXPECTED,yt as KEY_SELECTION,wt as MISSING_SERVER_METADATA,Y as None,w as OperationProcessingError,it as PARSE_ERROR,G as PrivateKeyJwt,ht as REQUEST_PROTOCOL_FORBIDDEN,nt as RESPONSE_BODY_ERROR,dt as RESPONSE_IS_NOT_CONFORM,ut as RESPONSE_IS_NOT_JSON,pe as ResponseBodyError,Z as TlsClientAuth,at as UNSUPPORTED_OPERATION,y as UnsupportedOperationError,le as WWWAuthenticateChallengeError,tt as WWW_AUTHENTICATE_CHALLENGE,mn as _expectedIssuer,fn as _nodiscoverycheck,ln as _nopkce,r as allowInsecureRequests,Ge as authorizationCodeGrantRequest,rn as backchannelAuthenticationGrantRequest,an as backchannelAuthenticationRequest,W as calculatePKCECodeChallenge,se as checkProtocol,gt as clientCredentialsGrantRequest,i as clockSkew,o as clockTolerance,c as customFetch,Gt as deviceAuthorizationRequest,Yt as deviceCodeGrantRequest,A as discoveryRequest,cn as dynamicClientRegistrationRequest,Ze as expectNoNonce,Mt as expectNoState,Xt as generateKeyPair,L as generateRandomCodeVerifier,J as generateRandomNonce,H as generateRandomState,St as genericTokenEndpointRequest,Ie as getValidatedIdTokenClaims,At as introspectionRequest,ue as isDPoPNonceError,ee as issueRequestObject,d as jweDecrypt,p as jwksCache,u as modifyAssertion,et as processAuthorizationCodeResponse,on as processBackchannelAuthenticationGrantResponse,sn as processBackchannelAuthenticationResponse,kt as processClientCredentialsResponse,Qt as processDeviceAuthorizationResponse,Zt as processDeviceCodeResponse,j as processDiscoveryResponse,un as processDynamicClientRegistrationResponse,vt as processGenericTokenEndpointResponse,Tt as processIntrospectionResponse,Se as processPushedAuthorizationResponse,Ke as processRefreshTokenResponse,pn as processResourceDiscoveryResponse,Rt as processRevocationResponse,De as processUserInfoResponse,Re as protectedResourceRequest,oe as pushedAuthorizationRequest,Je as refreshTokenGrantRequest,ie as resolveEndpoint,dn as resourceDiscoveryRequest,Pt as revocationRequest,Xe as skipAuthTimeCheck,qt as skipStateCheck,Oe as skipSubjectCheck,xe as userInfoRequest,Ce as validateApplicationLevelSignature,Ft as validateAuthResponse,It as validateCodeIdTokenResponse,Nt as validateDetachedSignatureResponse,tn as validateJwtAccessToken,Jt as validateJwtAuthResponse};export default null;
//# sourceMappingURL=/sm/fce55cdd3a6e8ce7ad2aae29c6bbec63d546625a2f806a9c0f9d891648e166a6.map